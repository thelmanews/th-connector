<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-selector/core-selector.html">

<link rel="import" href="../juicy-tile-list/src/juicy-tile-list.html">

<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../th-theme/th-theme.html">






<polymer-element name="th-connector" extend="d3-chart" attributes="">
  <core-style ref="theme"></theme>
  <template>
    <style>
      :host{
        font-size: 12px;
        font-family: open-sans, sans-serif;

      } 
      #chartData_anchor1 {
        position: absolute;
        top: 5px;
        left: 5px;
      }
      #chartData_anchor2 {
        position: absolute;
        top: 25px;
        left: 5px;
      }
      .anchor {
        width: 5px;
        height: 5px;
        background-color: #555;
        cursor: pointer;
      }
      .item {
        width: 100%;
        border-bottom: 1px solid #555;
        line-height: 1.4em;

      }
      .panel {
        border: 1px solid #AAA;
        background-color: rgba(255,255,255,0.9);
        padding: 5px;
        margin: 10px;
        position: relative;
        width: 900px;
        z-index: 110;

      }
      .panel .selector {
        display: inline;
        margin-right: 10px; 

      }
      .panel core-selector {
        width: 150px;
        display: inline-block;
        vertical-align: top;
      }
      .panel .core-selected {
        background-color: #ccc;
        border: 1px solid #888;
      }
      .panel label {
        display: inline-block;
        vertical-align: top;
      }
      .connections {
        margin-top: 10px;
      }

      .connections ul {
        list-style: none;
        width: 80%;
        padding: 0;
        margin: 0;
      }
      .connections ul li {
        margin: 3px 0;
      }
      .connections .del {
        float: right;
        color: #2fa3af;
      }

      .panel #connect {

        display: none;
        position: absolute;
        top: 0;
        right: 0;
        background-color: #2fa3af;
        color: #EEE;
        border: 1px solid #AAA;

      }

      a, a:visited {
        color: #555;
        text-decoration: none;
      }

      .panel h3 {
        font-family: arial;
        margin: 5px 0px;
        font-weight: normal;
      }

      label {
        color: #2fa3af;
      }

      ::content  .selected-src-element {
        border: 3px solid #66CCFF;
        margin: 0;

        box-sizing:border-box;
        -moz-box-sizing:border-box;
        -webkit-box-sizing:border-box;
      }
      ::content  .selected-target-element {
        border: 3px solid #00FF99  ;
        margin: 0;

        box-sizing:border-box;
        -moz-box-sizing:border-box;
        -webkit-box-sizing:border-box;
      }
      
      ::content > *:not(ul) { /* selects the elements */
        min-width: 20px;
        min-height: 20px;
        /*border: 1px solid #DDD;*/
        margin: 2px;
        display: inline-block;
        position: relative;
        /* border inside */
        vertical-align: top;
      }


      .elTitle {
        color: #2fa3af;
        padding: 2px;
      }
      
      .wrapper {
        border: 2px solid #ddd;
        display: inline-block;
        position: relative;
        margin: 20px;
        margin-left: 60px;
      }

      .connections-tab {
        width: 40px;
        margin-left: -40px;
        position: absolute;
        top: 0;

      }

      .wrapper li {
        list-style: none;
        /*margin-left: -40px;*/
        /*display: inline-block;*/
        position: relative;
        font-size: 9px;
      }

      


      .inputMarker {
        /*margin-left: -40px;*/
        width: 30px;
        height: 30px;
        border: 3px solid #ddd;
        border-radius: 15px;
        box-sizing: border-box;
        /*margin-top: 0px;*/
      }

      .outputMarker {
        width: 30px;
        height: 30px;
        border: 3px solid #ddd;
        border-radius: 15px;
        box-sizing: border-box;
      }

      .wrapper label{
        position: absolute;
        top: -20px;
        left: 0;
        padding: 0;
        overflow: visible;

      }



    </style>
    <div class="connectors">
    </div>

    <span class="elTitle">th-connector</span>

    <core-icon-button icon="perm-data-setting" on-click="{{showControls}}"></core-icon-button>

    <core-collapse id="ctrl_collapse">
  
      <div class="panel">
        <h3>Connection Panel</h3>
        <div class="from selector">
          <label for="src_component">From:</label>
          <core-selector id="src_component">
            <template repeat="{{el in elements}}">
              <div class="item">{{el.name}}<template if="{{el.element.id}}">#{{el.element.id}}</template></div>
            </template>

          </core-selector>
          <label for="src_attrs">Attributes:</label>
          <core-selector id="src_attrs">
            <template repeat="{{attr in _srcAttrs}}">
              <div class="item">{{attr}}</div>
            </template>

          </core-selector>
        </div>
        <div class="to selector">
          <label for="target_component">To:</label>
          <core-selector id="target_component">
            <template repeat="{{el in elements}}">
              <div class="item">{{el.name}}<template if="{{el.element.id}}">#{{el.element.id}}</template></div>
            </template>

          </core-selector>
          <label for="target_attrs">Attributes:</label>
          <core-selector id="target_attrs">
            <template repeat="{{attr in _targetAttrs}}">
              <div class="item">{{attr}}</div>
            </template>

          </core-selector>
        </div>
  <!--       <template if="{{_srcPropertySelection && _targetPropertySelection}}">
   -->        
            <input type="button" id="connect" value="connect" style="{{(_srcPropertySelection && _targetPropertySelection) ? 'display: block' : ''}}"></input>
  <!--       </template>
   --> 
        <div class="connections">
            <label>connections: </label>
            <ul>
            <template repeat="{{connection, index in _connections}}">
              <li class="connection">{{connection.sourceEl}}->{{connection.sourceProperty}} => 
                      {{connection.targetEl}}->{{connection.targetProperty}}
                       <a href="javascript:void(0)" class="del" data-index="{{index}}" on-click={{_deleteConnectionHandler}}>delete</a></li>
            </template>
            </ul>
        </div>

      </div>
  </core-collapse>

  <div id="container" on-dragover="{{allowDrop}}" on-drop="{{_removeConnection}}">
    <template repeat="{{el, index in elements}}">
      <div class="wrapper {{el.name}}" on-th-output-changed="{{displayOutputAvailable}}">
        <label>{{el.name}}</label>
        
        <div id="connections" class="connections-tab" >
          <!-- Input -->
          <template if="{{el.element.publish | checkForInputAttr}}">
            <li class="{{el.name}} inputMarker" on-dragover="{{dragOver}}" on-dragStart="{{dragStart}}" on-dragleave="{{dragLeave}}" on-drop="{{dropped}}" dropzone="true" style="background-color: {{el.inputConnectedTo ? el.inputConnectedTo.color : 'none'}}; border-color:{{el.inputConnectedTo ? el.inputConnectedTo.color : '#ddd'}};" draggable="true"></li>
            <li>Input</li>
          </template>

          <!-- Output -->
          <template if="{{el.element.publish | checkForOutputAttr}}">
            <li id="{{index}}"  class="{{el.name}} outputMarker" on-dragStart="{{dragStart}}" on-drag="{{drag}}" on-dragEnd="{{dragEnd}}" on-drop="{{dropped}}" draggable="true"></li>
            <li>Output</li>
          </template>
        </div>
        <content select="{{el.name}}"></content>
        

      </div>
    </template>
  </div>



  </template>



  <script>

      Polymer('th-connector', {
        elements: [],
        _srcAttrs: [],
        _targetAttrs: [],
        _srcElementSelection: null,
        _srcPropertySelection: null,
        _targetElementSelection: null,
        _targetPropertySelection: null,
        _connections: [],

        domReady: function() {
          var self = this;

          self.colors = self.getThemeColors();
          self._updateFields();

          // update fields when an element is added to the component (e.g. added to content)
          //this.onMutation(this, self._updateFields);
          
          this.watchMutation();

          self.$.src_component.addEventListener('core-select', function() {
            if(!this.selection) {
              return;
            }
            var prev = self.querySelector('.selected-src-element')
            if(prev) {
              prev.classList.remove('selected-src-element');
            }
            self.querySelector(this.selection.textContent).classList.add('selected-src-element');
            self._srcElementSelection = this.selection.textContent;
            self._srcAttrs = self._displayFields(this);
            self._srcPropertySelection = null;

          });
          self.$.src_attrs.addEventListener('core-select', function() {
            if(!this.selection) {
              return;
            }
            self._srcPropertySelection = this.selection.textContent;

          });



          self.$.target_component.addEventListener('core-select', function() {
            if(!this.selection) {
              return;
            }
            self._targetElementSelection = this.selection.textContent;
            var prev = self.querySelector('.selected-target-element')
            if(prev) {
              prev.classList.remove('selected-target-element');
            }
            self.querySelector(this.selection.textContent).classList.add('selected-target-element');
            self._targetAttrs = self._displayFields(this);
            self._targetPropertySelection = null;

          });
          self.$.target_attrs.addEventListener('core-select', function() {
            if(!this.selection) {
              return;
            }
            self._targetPropertySelection = this.selection.textContent;

          });

          self.$.connect.addEventListener('click', function() {
            self.connectAttributes(self._srcElementSelection, self._srcPropertySelection,
                                 self._targetElementSelection, self._targetPropertySelection);


          });


          
          /*


          self.connectAttributes('th-csv','filteredData','#filtered','data');

          //self.connectAttributes('th-csv','data','#unfiltered','data');

          //self.connectAttributes('th-csv','chartDataOutput','th-n-bar-chart','chartData');

          self.connectAttributes('#url','value','th-csv','url');

          self.connectAttributes('#col_from','value','th-csv','filter_col_from');
          self.connectAttributes('#col_to','value','th-csv','filter_col_to');
          self.connectAttributes('#row_from','value','th-csv','filter_row_from');
          self.connectAttributes('#row_to','value','th-csv','filter_row_to');


          self.connectAttributes('th-csv','data','th-basic-function','dataIn');


          */


        },

        _updateFields: function() {
          var self = this;
          var boringTags = ['div','ul','li','span','th-editor','br'];

          self.elements = [];

          var components = self.querySelectorAll('*'); //self.children;
          [].forEach.call(components, function(el) {
              el.setAttribute('draggable',true);
              el.addEventListener('dragstart',function(e) {
                console.log('drag');
                this.style.opacity= 0;
              });
              el.addEventListener('dragend',function(e) {
                console.log('drag');
                this.style.opacity= 1;
              });
              var index=boringTags.indexOf(el.tagName.toLowerCase());
              if(index<0) {
                // self.elements.push(el);
                self.elements.push({  element: el, 
                                      name: el.tagName.toLowerCase(), 
                                      outputReady: false
                                  });
              }
          
          });

          for (var i=0; i<self.elements.length; i++){
            self.elements[i].color = self.colors.accents[i];

          }
          console.log("$$$$");
          console.log(self.elements);

        },

        _displayFields: function(selector) {

          console.log("display fields");
          var self = this;
          var elSelector = selector.selection.textContent;
          var el = self.querySelector(elSelector);
          if(!el) {
            return;
          }
          var metadata = (typeof el.getMetaData === 'function') ? el.getMetaData : null; 

                   
          var attrs = el.publish;
          var attrsObj = [];
          for(key in attrs) {
            attrsObj.push(key);

          }
          return attrsObj;
          
        },

        connectAttributes: function(source, sourceField, target, targetField) {
          console.log("connect attributes");
          var self = this;

          // check if source/target are dom element or query selector string:
          var source = (typeof source === "string") ? self.querySelector(source) : source;
          var target = (typeof target === "string") ? self.querySelector(target): target;
 
          // select the source and target el in the elements array
          var sourceEl = self.elements.filter(function(el){
            return el.element == source;
          })[0];

          var targetEl = self.elements.filter(function(el){
            return el.element == target;
          })[0];

          targetEl.inputConnectedTo = sourceEl;
          console.log(targetEl);
          // target.setAttribute.draggable = true;

          // for (var i=0; i<self.elements.length; i++){
          //   if(self.elements[i].element == target){
          //     self.elements[i].inputConnectedTo = sourceEl;
          //   }  
          // }

          var observer = new PathObserver(sourceEl.element, sourceField);
   
               observer.open(function(newValue, oldValue) {
               targetEl[targetField] = newValue;
               
          });

          //to set the value when elements are connected
          targetEl.element[targetField] = sourceEl.element[sourceField];  

          self._connections.push({
            // sourceEl: (typeof source === "string") ? source : source.tagName+(source.id ? '#'+source.id : ''),
            sourceEl: sourceEl.name + (sourceEl.element.id ? sourceEl.element.id : ''),
            sourceProperty: sourceField,
            targetEl: targetEl.name + (targetEl.element.id ? targetEl.element.id : ''),
            // targetEl: (typeof target === "string") ? target : target.tagName+(target.id ? '#'+target.id : ''),
            targetProperty: targetField,
            observer: observer
         });


        },

        _deleteConnectionHandler: function(e, detail, sender) {
          console.log("delete connection handler");
          var self = this;
          var index = e.target.getAttribute('data-index');
          var observer = self._connections[index].observer;
          observer.close();
          self._connections.splice(index, 1);

        },
        _removeConnection: function(e, detail, selection){
          var self = this;
          
          // Select the element being dragged from elements array
          var sourceEl = self.elements.filter(function(el){
            return el.name == self.fromEl.classList[0];
          })[0];
          

          // Check if the element is not the container and if it has a connection, then ask to remove it
          if (self.fromEl.classList.contains("inputMarker") && sourceEl.inputConnectedTo ){
            if (confirm('Do you want to remove this connection?')) {
                sourceEl.element.input = null;
                sourceEl.inputConnectedTo = false;
            } 
          }
        },
        showControls: function(e) {
          console.log("show controls");
          this.$.ctrl_collapse.toggle();
        } ,

        watchMutation: function() {
          console.log("watch mutation");
            var change = function() {

              this._updateFields();

              this.onMutation(this, change);
            }.bind(this);


            this.onMutation(this, change);


          },
        checkForInputAttr: function(value){

          return Object.keys(value).indexOf("input") > -1 ? true : false;
        },
        checkForOutputAttr: function(value){
          // console.log(Object.keys(value));
          return Object.keys(value).indexOf("output") > -1 ? true : false;
        },
        dragStart: function(e, detail, selection){
          this.fromEl = selection;
          console.log(this.fromEl);
          
          // selection.style.border = "3px solid "+this.colors.accents[selection.id];
        },
        drag: function(e, detail, selection){
          // console.log(e);
        },
        dragEnd: function(e, detail, selection){
          // console.log(e);
        },
        dragOver: function(e, detail, selection){
          selection.style.border = "3px solid "+this.colors.accents[this.fromEl.id];  
          event.preventDefault(); // allows drop event on this element

        },
        allowDrop: function(e,detail,selection){
          console.log('allow drop');
          event.preventDefault(); // allows drop event on this element
        },
        dragLeave: function(e, detail, selection){
          // selection.style.border = "3px solid #ddd";
        },
        dropped: function(e, detail, selection){
          console.log("drop");
          selection.style.border = "3px solid "+this.colors.accents[this.fromEl.id];
          // selection.style.backgroundColor = this.colors.accents[this.fromEl.id];
          this.connectAttributes(this.fromEl.classList[0],'output',selection.classList[0],'input');
          
        },
        getThemeColors: function(){
          var colors = {};
          colors.theme = window.CoreStyle.g.theme;
          colors.accents = [];

          for (var color in colors.theme){
            if(/^accent/.test(color)){
              colors.accents.push(colors.theme[color]);
            }
          }
          var newAccents = colors.accents.map(function(color){
        
            var color = color,
                lum = 0.3, // represents % lighter or darker (negative values are darker)
                hex = "#", c, i;
            
            // validate color and make it always 6 chars 
            color = String(color).replace(/[^0-9a-f]/gi, '');
            if (color.length < 6) {
              color = color[0]+color[0]+color[1]+color[1]+color[2]+color[2];
            }

            // convert color to decimal, adjust lumosity, and convert back to hex;
            for (i = 0; i < 3; i++) {
              c = parseInt(color.substr(i*2,2), 16);
              c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
              hex += ("00"+c).substr(c.length);
            }

            return hex;
            
          });

          colors.accents = colors.accents.concat(newAccents);
          
          return colors;
        },
        displayOutputAvailable: function(e){
          var el  = e.detail.tagName.toLowerCase();
          var output = e.detail.output;
          var outputMarker = this.$.container.querySelector('li.'+el+ '.outputMarker');
          if (output.length>0){
            var outputId = outputMarker.id;
            outputMarker.style.border="3px solid "+this.colors.accents[outputId];
          } else {
            outputMarker.style.border="3px solid #ddd";
          }

        }
      });

  </script>
</polymer-element>
